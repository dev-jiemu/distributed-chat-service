<!DOCTYPE html>
<html>
<head>
    <title>Distributed Chat Test Client - STOMP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #chat-container {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }
        .message.own {
            text-align: right;
            background-color: #dcf8c6;
            margin-left: 20%;
        }
        .message.other {
            text-align: left;
            background-color: #fff;
            margin-right: 20%;
            border: 1px solid #ddd;
        }
        .message.system {
            text-align: center;
            color: gray;
            font-style: italic;
            background-color: transparent;
        }
        .message.typing {
            color: #666;
            font-style: italic;
        }
        .message-time {
            font-size: 0.8em;
            color: #666;
        }
        #input-container {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #connection-status {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
        }
        #status {
            font-weight: bold;
        }
        #status.connected {
            color: green;
        }
        #status.disconnected {
            color: red;
        }
        #typing-indicator {
            height: 20px;
            color: #666;
            font-style: italic;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Distributed Chat Service - STOMP Client</h1>
    
    <div id="connection-status">
        Status: <span id="status" class="disconnected">Disconnected</span> | 
        User ID: <input type="text" id="userId" value="user1" size="10">
        <button onclick="connect()" id="connect-btn">Connect</button>
        <button onclick="disconnect()" id="disconnect-btn" disabled>Disconnect</button>
    </div>
    
    <div>
        Send To: <input type="text" id="receiverId" placeholder="Receiver User ID">
        <span style="margin-left: 20px;">OR Room: <input type="text" id="roomId" placeholder="Room ID (not implemented)"></span>
    </div>
    
    <div id="chat-container"></div>
    
    <div id="typing-indicator"></div>
    
    <div id="input-container">
        <input type="text" id="message-input" placeholder="Type a message..." disabled onkeyup="handleTyping(event)">
        <button id="send-button" onclick="sendMessage()" disabled>Send</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentUserId = null;
        let typingTimer = null;
        let isTyping = false;

        function connect() {
            currentUserId = document.getElementById('userId').value;
            if (!currentUserId) {
                alert('Please enter a User ID');
                return;
            }

            // SockJS 연결 생성
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);
            
            // 디버그 모드 비활성화 (콘솔 로그 줄이기)
            stompClient.debug = null;

            // STOMP 연결
            stompClient.connect(
                { userId: currentUserId }, // 헤더로 userId 전달
                onConnected,
                onError
            );
        }

        function onConnected() {
            updateStatus('Connected');
            
            // 개인 메시지 큐 구독
            stompClient.subscribe('/user/queue/messages', onMessageReceived);
            
            // 브로드캐스트 메시지 구독 (옵션)
            // stompClient.subscribe('/topic/public', onMessageReceived);
            
            // 접속 알림 전송
            stompClient.send('/app/chat.addUser', {}, JSON.stringify({
                sender: currentUserId,
                type: 'JOIN'
            }));
            
            displayMessage({
                type: 'SYSTEM',
                content: 'Connected to chat server'
            });
            
            console.log('Connected to STOMP server');
        }

        function onError(error) {
            updateStatus('Disconnected');
            displayMessage({
                type: 'SYSTEM',
                content: 'Connection error: ' + error
            });
            console.error('STOMP connection error:', error);
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect(() => {
                    updateStatus('Disconnected');
                    displayMessage({
                        type: 'SYSTEM',
                        content: 'Disconnected from chat server'
                    });
                });
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const receiverId = document.getElementById('receiverId').value;
            const roomId = document.getElementById('roomId').value;
            const messageContent = messageInput.value.trim();
            
            if (!messageContent) {
                return;
            }
            
            const chatMessage = {
                sender: currentUserId,
                receiver: receiverId || null,
                roomId: roomId || null,
                content: messageContent,
                type: 'CHAT'
            };
            
            // STOMP로 메시지 전송
            stompClient.send('/app/chat.send', {}, JSON.stringify(chatMessage));
            
            messageInput.value = '';
            clearTypingIndicator();
        }

        function onMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            
            switch (message.type) {
                case 'CHAT':
                    displayMessage(message);
                    // 다른 사용자의 메시지인 경우 읽음 확인 전송
                    if (message.sender !== currentUserId) {
                        sendReadReceipt(message);
                    }
                    break;
                case 'JOIN':
                    displayMessage({
                        type: 'SYSTEM',
                        content: message.sender + ' joined the chat'
                    });
                    break;
                case 'LEAVE':
                    displayMessage({
                        type: 'SYSTEM',
                        content: message.sender + ' left the chat'
                    });
                    break;
                case 'TYPING':
                    showTypingIndicator(message.sender);
                    break;
                case 'READ':
                    updateMessageStatus(message.id, 'read');
                    break;
            }
        }

        function displayMessage(message) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            if (message.type === 'SYSTEM') {
                messageElement.classList.add('system');
                messageElement.textContent = message.content;
            } else {
                const isOwn = message.sender === currentUserId;
                messageElement.classList.add(isOwn ? 'own' : 'other');
                
                const time = message.timestamp ? 
                    new Date(message.timestamp).toLocaleTimeString() : 
                    new Date().toLocaleTimeString();
                
                messageElement.innerHTML = `
                    <div><strong>${message.sender}:</strong> ${message.content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                if (message.id) {
                    messageElement.setAttribute('data-message-id', message.id);
                }
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function handleTyping(event) {
            if (event.key === 'Enter') {
                sendMessage();
                return;
            }
            
            const receiverId = document.getElementById('receiverId').value;
            if (!receiverId || !stompClient || !stompClient.connected) {
                return;
            }
            
            if (!isTyping) {
                isTyping = true;
                stompClient.send('/app/chat.typing', {}, JSON.stringify({
                    sender: currentUserId,
                    receiver: receiverId,
                    type: 'TYPING'
                }));
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                isTyping = false;
            }, 1000);
        }

        function showTypingIndicator(userId) {
            const indicator = document.getElementById('typing-indicator');
            indicator.textContent = userId + ' is typing...';
            
            setTimeout(() => {
                indicator.textContent = '';
            }, 3000);
        }

        function sendReadReceipt(message) {
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/chat.read', {}, JSON.stringify({
                    id: message.id,
                    sender: currentUserId,
                    receiver: message.sender,
                    type: 'READ'
                }));
            }
        }

        function updateMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const timeDiv = messageElement.querySelector('.message-time');
                if (timeDiv && !timeDiv.textContent.includes('✓✓')) {
                    timeDiv.textContent += ' ✓✓';
                }
            }
        }

        function clearTypingIndicator() {
            isTyping = false;
            clearTimeout(typingTimer);
        }

        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = status;
            statusElement.className = status.toLowerCase();
            
            const isConnected = status === 'Connected';
            document.getElementById('connect-btn').disabled = isConnected;
            document.getElementById('disconnect-btn').disabled = !isConnected;
            document.getElementById('message-input').disabled = !isConnected;
            document.getElementById('send-button').disabled = !isConnected;
        }

        // Enter 키로 메시지 전송
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
