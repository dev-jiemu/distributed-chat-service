<!DOCTYPE html>
<html>
<meta charset="UTF-8">
    <title>Chat Service</title>
    <style>
        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 로딩 화면 */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #loading-screen.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 헤더 */
        #header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #user-nickname {
            font-weight: bold;
        }

        #status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 3px;
            background-color: rgba(255,255,255,0.2);
        }

        #status.connected {
            background-color: #27ae60;
        }

        #status.disconnected {
            background-color: #e74c3c;
        }

        /* 채팅방 리스트 & 채팅 컨테이너 */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #room-list {
            width: 250px;
            background-color: #34495e;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        #room-list h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .room-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .room-item:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .room-item.active {
            background-color: #3498db;
        }

        /* 채팅 영역 */
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        #chat-header {
            padding: 15px 20px;
            background-color: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.own .message-bubble {
            background-color: #3498db;
            color: white;
        }

        .message.other .message-bubble {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .message-info {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        .message.own .message-info {
            text-align: right;
        }

        .message.system {
            justify-content: center;
            font-style: italic;
            color: #7f8c8d;
            font-size: 14px;
        }

        #typing-indicator {
            padding: 0 20px 10px;
            font-size: 14px;
            color: #7f8c8d;
            font-style: italic;
            min-height: 20px;
        }

        /* 입력 영역 */
        #input-container {
            padding: 15px 20px;
            background-color: #ecf0f1;
            border-top: 1px solid #bdc3c7;
            display: flex;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        #send-button {
            padding: 10px 25px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #send-button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 닉네임 입력 모달 */
        #nickname-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #nickname-modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .modal-content button {
            padding: 10px 30px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-content button:hover {
            background-color: #2980b9;
        }

        /* 1:1 채팅 시작 섹션 */
        #private-chat-section {
            padding: 10px 20px;
            background-color: #2c3e50;
            border-top: 1px solid #34495e;
        }

        #private-chat-section input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255,255,255,0.1);
            color: white;
            outline: none;
        }

        #private-chat-section input::placeholder {
            color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
<!-- 로딩 화면 -->
<div id="loading-screen">
    <div class="spinner"></div>
    <p style="margin-top: 20px;">채팅 서비스에 연결 중...</p>
</div>



<!-- 헤더 -->
<div id="header">
    <h2 style="margin: 0;">채팅 서비스</h2>
    <div id="user-info">
        <span id="user-nickname"></span>
        <span id="status" class="disconnected">연결 끊김</span>
        <button onclick="logout()" style="margin-left: 10px; padding: 5px 15px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">로그아웃</button>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div id="main-container">
    <!-- 채팅방 리스트 -->
    <div id="room-list">
        <h3>채팅</h3>
        <div id="room-items">
            <!-- 채팅방 목록이 여기에 추가됩니다 -->
        </div>

        <!-- 1:1 채팅 시작 -->
        <div id="private-chat-section">
            <input type="text" id="new-chat-input" placeholder="사용자 ID로 1:1 채팅 시작" onkeypress="handleNewChat(event)">
        </div>
    </div>

    <!-- 채팅 영역 -->
    <div id="chat-area">
        <div id="chat-header">
            <h3 id="chat-title">채팅을 선택하세요</h3>
        </div>
        <div id="chat-container"></div>
        <div id="typing-indicator"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="메시지를 입력하세요..." disabled onkeyup="handleTyping(event)">
            <button id="send-button" onclick="sendMessage()" disabled>전송</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentUser = null;
    let currentChatPartner = null;
    let typingTimer = null;
    let isTyping = false;
    let chatHistory = {}; // 채팅 기록 저장

    // 전역 fetch 인터셉터 - 모든 API 요청에 JWT 토큰 자동 추가
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        let [resource, config] = args;

        // API 요청인 경우에만 토큰 추가
        if (typeof resource === 'string' && resource.startsWith('/api/')) {
            const token = localStorage.getItem('accessToken');
            if (token) {
                config = config || {};
                config.headers = config.headers || {};
                config.headers['Authorization'] = 'Bearer ' + token;
            }
        }

        return originalFetch(resource, config);
    };

    // 페이지 로드 시 초기화
    window.onload = function() {
        checkUserSession();
    };

    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            return null;
        }
    }

    // 사용자 세션 확인
    async function checkUserSession() {
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            window.location.href = '/index.html';
            return;
        }

        const decodedToken = parseJwt(accessToken);
        if (!decodedToken || decodedToken.exp * 1000 < Date.now()) {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '/index.html';
            return;
        }

        currentUser = {
            userId: decodedToken.sub,
            nickname: decodedToken.sub 
        };
        
        document.getElementById('user-nickname').textContent = currentUser.nickname;
        hideLoadingScreen();
        connectWebSocket(accessToken);
    }

    // 로딩 화면 숨기기
    function hideLoadingScreen() {
        document.getElementById('loading-screen').classList.add('hidden');
    }

    // WebSocket 연결
    function connectWebSocket(token) {
        const socket = new SockJS('/ws-chat?token=' + token);
        stompClient = Stomp.over(socket);

        // 디버그 모드 비활성화
        stompClient.debug = null;

        stompClient.connect(
                {},
                onConnected,
                onError
        );
    }

    function onConnected() {
        updateStatus('연결됨');

        // 개인 메시지 큐 구독
        stompClient.subscribe('/user/queue/messages', onMessageReceived);

        // 에러 메시지 구독 (Rate Limit 등)
        stompClient.subscribe('/user/queue/errors', onErrorReceived);

        displayMessage({
            type: 'SYSTEM',
            content: '채팅 서버에 연결되었습니다.'
        });

        // 입력 필드 활성화
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-button').disabled = false;
    }

    function onError(error) {
        updateStatus('연결 끊김');
        displayMessage({
            type: 'SYSTEM',
            content: '연결 오류: ' + error
        });
        console.error('STOMP connection error:', error);
    }

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();

        if (!content || !currentChatPartner) {
            return;
        }

        const message = {
            sender: currentUser.userId,
            receiver: currentChatPartner,
            content: content,
            type: 'CHAT',
            timestamp: new Date().toISOString()
        };

        // STOMP로 메시지 전송
        stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(message));

        // 자신의 메시지 즉시 표시
        displayMessage({
            ...message,
            own: true
        });

        messageInput.value = '';
        clearTypingIndicator();
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);

        switch (message.type) {
            case 'CHAT':
                // 채팅방 목록에 추가
                updateChatList(message.sender);

                // 현재 대화 상대의 메시지인 경우만 표시
                if (message.sender === currentChatPartner) {
                    displayMessage(message);
                } else {
                    // 다른 사용자의 메시지는 알림 표시
                    showNotification(message.sender);
                }

                // 채팅 기록에 저장
                saveToChatHistory(message.sender, message);
                break;

            case 'JOIN':
                displayMessage({
                    type: 'SYSTEM',
                    content: message.sender + '님이 접속했습니다.'
                });
                break;

            case 'LEAVE':
                displayMessage({
                    type: 'SYSTEM',
                    content: message.sender + '님이 나갔습니다.'
                });
                break;
        }
    }

    // Rate Limit 등 에러 메시지 처리
    function onErrorReceived(payload) {
        const error = JSON.parse(payload.body);
        console.error('Server error:', error);

        if (error.code === 'RATE_LIMIT_EXCEEDED') {
            displayMessage({
                type: 'SYSTEM',
                content: `⚠️ ${error.message} (${error.retryAfterSeconds}초 후 재시도)`
            });

            // 일시적으로 입력 비활성화
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            messageInput.disabled = true;
            sendButton.disabled = true;

            setTimeout(() => {
                messageInput.disabled = false;
                sendButton.disabled = false;
                displayMessage({
                    type: 'SYSTEM',
                    content: '✅ 메시지 전송이 다시 가능합니다.'
                });
            }, error.retryAfterSeconds * 1000);
        } else {
            displayMessage({
                type: 'SYSTEM',
                content: `❌ 오류: ${error.message}`
            });
        }
    }

    function displayMessage(message) {
        const chatContainer = document.getElementById('chat-container');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        if (message.type === 'SYSTEM') {
            messageElement.classList.add('system');
            messageElement.textContent = message.content;
        } else {
            const isOwn = message.sender === currentUser.userId || message.own;
            messageElement.classList.add(isOwn ? 'own' : 'other');

            const time = message.timestamp ?
                    new Date(message.timestamp).toLocaleTimeString() :
                    new Date().toLocaleTimeString();

            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            bubble.textContent = message.content;

            const info = document.createElement('div');
            info.classList.add('message-info');
            info.textContent = time;

            messageElement.appendChild(bubble);
            messageElement.appendChild(info);
        }

        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function handleTyping(event) {
        if (event.key === 'Enter') {
            sendMessage();
            return;
        }

        if (!currentChatPartner || !stompClient || !stompClient.connected) {
            return;
        }

        if (!isTyping) {
            isTyping = true;
            stompClient.send('/app/chat.typing', {}, JSON.stringify({
                sender: currentUser.userId,
                receiver: currentChatPartner,
                type: 'TYPING'
            }));
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            isTyping = false;
        }, 1000);
    }

    function showTypingIndicator(userId) {
        const indicator = document.getElementById('typing-indicator');
        indicator.textContent = userId + '님이 입력 중...';

        setTimeout(() => {
            indicator.textContent = '';
        }, 3000);
    }

    function clearTypingIndicator() {
        isTyping = false;
        clearTimeout(typingTimer);
    }

    function updateStatus(status) {
        const statusElement = document.getElementById('status');
        statusElement.textContent = status;
        statusElement.className = status === '연결됨' ? 'connected' : 'disconnected';
    }

    // 새로운 1:1 채팅 시작
    function handleNewChat(event) {
        if (event.key === 'Enter') {
            const input = document.getElementById('new-chat-input');
            const targetUserId = input.value.trim();

            if (targetUserId && targetUserId !== currentUser.userId) {
                selectChat(targetUserId);
                input.value = '';
            }
        }
    }

    // 채팅 선택
    function selectChat(userId) {
        currentChatPartner = userId;

        // UI 업데이트
        document.getElementById('chat-title').textContent = userId + '님과의 대화';

        // 채팅방 목록 업데이트
        updateChatList(userId);

        // 이전 채팅 내용 표시
        loadChatHistory(userId);

        // 활성 채팅방 표시
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeItem = document.querySelector(`[data-user-id="${userId}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }

    // 채팅방 목록 업데이트
    function updateChatList(userId) {
        const roomItems = document.getElementById('room-items');
        let roomItem = document.querySelector(`[data-user-id="${userId}"]`);

        if (!roomItem) {
            roomItem = document.createElement('div');
            roomItem.classList.add('room-item');
            roomItem.setAttribute('data-user-id', userId);
            roomItem.onclick = () => selectChat(userId);
            roomItems.appendChild(roomItem);
        }

        roomItem.textContent = userId;

        // 최근 대화를 위로
        roomItems.prepend(roomItem);
    }

    // 채팅 기록 저장
    function saveToChatHistory(userId, message) {
        if (!chatHistory[userId]) {
            chatHistory[userId] = [];
        }
        chatHistory[userId].push(message);
    }

    // 채팅 기록 불러오기
    function loadChatHistory(userId) {
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';

        if (chatHistory[userId]) {
            chatHistory[userId].forEach(message => {
                displayMessage(message);
            });
        }
    }

    // 알림 표시 (간단한 구현)
    function showNotification(userId) {
        const roomItem = document.querySelector(`[data-user-id="${userId}"]`);
        if (roomItem && !roomItem.classList.contains('active')) {
            roomItem.style.backgroundColor = '#e74c3c';
            setTimeout(() => {
                roomItem.style.backgroundColor = '';
            }, 3000);
        }
    }

    // Enter 키로 메시지 전송
    document.getElementById('message-input')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // 로그아웃
    function logout() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/index.html';
    }
</script>
</body>
</html>