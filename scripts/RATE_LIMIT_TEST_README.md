# ğŸ§ª Rate Limiting í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

ëŒ€ìš©ëŸ‰ ì±„íŒ… ì„œë¹„ìŠ¤ì˜ Rate Limiting ê¸°ëŠ¥ì„ Pythonìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

## ğŸ“‹ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **Token Bucket ì•Œê³ ë¦¬ì¦˜** ê¸°ë°˜ì˜ Rate Limitingì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### Rate Limiting ì„¤ì •
- **ìµëª… ì‚¬ìš©ì**: ë¶„ë‹¹ 200ê°œ, ë²„ìŠ¤íŠ¸ 100ê°œ
- **ì¸ì¦ ì‚¬ìš©ì**: ë¶„ë‹¹ 500ê°œ, ë²„ìŠ¤íŠ¸ 100ê°œ
- **ì•Œê³ ë¦¬ì¦˜**: Token Bucket
- **ì €ì¥ì†Œ**: Redis

## ğŸš€ ì‹œì‘í•˜ê¸°

### 1. í™˜ê²½ ì¤€ë¹„

```bash
# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
pip install -r scripts/requirements.txt

# ë˜ëŠ” ê°œë³„ ì„¤ì¹˜
pip install redis stomp.py websocket-client requests
```

### 2. ì„œë¹„ìŠ¤ ì‹¤í–‰

```bash
# Docker Composeë¡œ ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰
docker-compose up -d

# ì„œë¹„ìŠ¤ í™•ì¸
docker-compose ps

# ë¡œê·¸ í™•ì¸
docker-compose logs -f chat-server
```

**í™•ì¸ ì‚¬í•­:**
- chat-server: http://localhost:8081
- Redis: localhost:6379 (ë¹„ë°€ë²ˆí˜¸: test)
- RabbitMQ: localhost:5672 (ê´€ë¦¬ UI: http://localhost:15672)

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### Redis ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸ (ì¶”ì²œ)

**ê°€ì¥ ê°„ë‹¨í•˜ê³  ë¹ ë¥¸ ë°©ë²•ì…ë‹ˆë‹¤!**

```bash
cd scripts
python rate_limit_test_simple.py
```

**íŠ¹ì§•:**
- âœ… Redisì— ì§ì ‘ ì—°ê²°í•˜ì—¬ Rate Limit ìƒíƒœ í™•ì¸
- âœ… WebSocket ì—°ê²° ì—†ì´ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸
- âœ… ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥
- âœ… ì´ˆë³´ìì—ê²Œ ì í•©

**í…ŒìŠ¤íŠ¸ í•­ëª©:**
1. Rate Limit ìƒíƒœ ì‹œê°í™”
2. ë²„ìŠ¤íŠ¸ í•œë„ í…ŒìŠ¤íŠ¸ (100ê°œ í•œë„ í™•ì¸)
3. ë™ì‹œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ (50ëª… ë™ì‹œ ì ‘ì†)
4. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ì„ íƒ)

## ğŸ“Š í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ë²„ìŠ¤íŠ¸ í•œë„ í…ŒìŠ¤íŠ¸
ìµëª… ì‚¬ìš©ìê°€ 150ê°œ ë©”ì‹œì§€ë¥¼ ë¹ ë¥´ê²Œ ì „ì†¡í•˜ë©´?
- âœ… ì²˜ìŒ 100ê°œëŠ” ì„±ê³µ (ë²„ìŠ¤íŠ¸)
- âŒ ë‚˜ë¨¸ì§€ 50ê°œëŠ” Rate Limit ì°¨ë‹¨

### 2. ì •ìƒ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸
ì¼ë°˜ ì‚¬ìš©ìê°€ ë¶„ë‹¹ 50ê°œ ì „ì†¡í•˜ë©´?
- âœ… ëª¨ë‘ ì„±ê³µ (ì œí•œ ì´í•˜)

### 3. ë´‡ ê³µê²© í…ŒìŠ¤íŠ¸
ë´‡ì´ ì´ˆë‹¹ 1000ê°œë¥¼ 3ì´ˆê°„ ì „ì†¡í•˜ë©´?
- âœ… 95% ì´ìƒ ì°¨ë‹¨ë˜ì–´ì•¼ í•¨
- âœ… ìµœëŒ€ 150ê°œ ì •ë„ë§Œ í†µê³¼

### 4. ë™ì‹œ ì ‘ì†ì í…ŒìŠ¤íŠ¸
50ëª…ì´ ë™ì‹œì— ê° 100ê°œì”© ì „ì†¡í•˜ë©´?
- âœ… ê° ì‚¬ìš©ìëŠ” ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë¨
- âœ… ì „ì²´ ì²˜ë¦¬ëŸ‰ í™•ì¸

## ğŸ” ê²°ê³¼ í•´ì„

### ì„±ê³µì ì¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì˜ˆì‹œ

```
ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼
============================================================
ì´ ì‹œë„:            5,000ê°œ
ì„±ê³µ:               4,200ê°œ
ì‹¤íŒ¨:                 800ê°œ
Rate Limit:           800ê°œ
ì„±ê³µë¥ :             84.00%
ì†Œìš” ì‹œê°„:          12.45ì´ˆ
ì²˜ë¦¬ëŸ‰:            337.35 msg/sec
============================================================
```

### ì§€í‘œ í•´ì„
- **ì„±ê³µë¥  80-90%**: ì •ìƒ (ì¼ë¶€ëŠ” Rate Limitì— ê±¸ë¦¼)
- **ì°¨ë‹¨ìœ¨ > 95% (ë´‡ í…ŒìŠ¤íŠ¸)**: ë´‡ ë°©ì–´ ì„±ê³µ
- **ì²˜ë¦¬ëŸ‰**: ì„œë²„ ì„±ëŠ¥ ì§€í‘œ

## ğŸ› ï¸ ì»¤ìŠ¤í…€ í…ŒìŠ¤íŠ¸

### Rate Limit ì„¤ì • ë³€ê²½

`application.yml` ìˆ˜ì •:
```yaml
app:
  rate-limit:
    anonymous:
      limit: 200    # ë¶„ë‹¹ ë©”ì‹œì§€ ìˆ˜ ë³€ê²½
      burst: 100    # ë²„ìŠ¤íŠ¸ í•œë„ ë³€ê²½
```

ë³€ê²½ í›„ ì¬ì‹œì‘:
```bash
docker-compose restart chat-server
```

### í…ŒìŠ¤íŠ¸ íŒŒë¼ë¯¸í„° ì¡°ì •

`rate_limit_test_simple.py` ìˆ˜ì •:
```python
# ë™ì‹œ ì‚¬ìš©ì ìˆ˜ ë³€ê²½
user_count = 100  # ê¸°ë³¸: 50

# ë©”ì‹œì§€ ìˆ˜ ë³€ê²½
messages_per_user = 200  # ê¸°ë³¸: 100

# ëª¨ë‹ˆí„°ë§ ì‹œê°„ ë³€ê²½
duration = 30  # ê¸°ë³¸: 10ì´ˆ
```

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Redis ì—°ê²° ì‹¤íŒ¨
```
âŒ Redis ì—°ê²° ì‹¤íŒ¨: Error 111 connecting to localhost:6379
```

**í•´ê²°:**
```bash
# Redis ìƒíƒœ í™•ì¸
docker-compose ps redis

# Redis ì¬ì‹œì‘
docker-compose restart redis

# ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (docker-compose.yml)
# REDIS_PASSWORD=test
```

### Rate Limitì´ ì‘ë™í•˜ì§€ ì•ŠìŒ

**í™•ì¸ ì‚¬í•­:**
1. Redisê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ê°€?
   ```bash
   docker-compose exec redis redis-cli -a test
   > KEYS rate:*
   ```

2. chat-serverê°€ ì •ìƒ ì‹¤í–‰ë˜ëŠ”ê°€?
   ```bash
   docker-compose logs chat-server | grep "Rate"
   ```

3. Rate Limit ì„¤ì •ì´ ì˜¬ë°”ë¥¸ê°€?
   - `application.yml` ë˜ëŠ” `application-docker.yml` í™•ì¸

## ğŸ“š ì¶”ê°€ ì •ë³´

### Token Bucket ì•Œê³ ë¦¬ì¦˜

```
í˜„ì¬ í† í° = ì´ì „ í† í° + (ê²½ê³¼ ì‹œê°„ Ã— ì¶©ì „ ì†ë„)
ë‹¨, ìµœëŒ€ ìš©ëŸ‰ ì´ˆê³¼ ë¶ˆê°€

ì˜ˆì‹œ (ìµëª… ì‚¬ìš©ì):
- ë²„ìŠ¤íŠ¸: 100ê°œ
- ì¶©ì „ ì†ë„: 200/60 = 3.33 í† í°/ì´ˆ
- 1ë¶„ í›„ í† í°: 0 + (60ì´ˆ Ã— 3.33) = 200ê°œ (ìµœëŒ€ 100ê°œë¡œ ì œí•œ)
```

### Redis í‚¤ êµ¬ì¡°

```
rate:anon:{userId}    # ìµëª… ì‚¬ìš©ì
rate:auth:{userId}    # ì¸ì¦ ì‚¬ìš©ì

ê°’ (JSON):
{
  "tokens": 95.5,
  "maxTokens": 100,
  "refillRate": 3.33,
  "lastRefillTime": "2024-01-18T10:30:00"
}
```

### ì°¸ê³  ìë£Œ
- Token Bucket: https://etloveguitar.tistory.com/126
- Spring WebSocket: https://spring.io/guides/gs/messaging-stomp-websocket
- Redis Rate Limiting: https://redis.io/docs/manual/patterns/rate-limiter/

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ë¶€í•˜ í…ŒìŠ¤íŠ¸ í™•ì¥**: JMeter, Locust ë“±ìœ¼ë¡œ ëŒ€ê·œëª¨ í…ŒìŠ¤íŠ¸
2. **ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: Prometheus, Grafanaë¡œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
3. **ì•Œë¦¼ ì„¤ì •**: Rate Limit ì´ˆê³¼ ì‹œ Slack ì•Œë¦¼
4. **ë™ì  ì¡°ì •**: ë¶€í•˜ì— ë”°ë¼ Rate Limit ìë™ ì¡°ì •

## ğŸ“ ë¬¸ì˜

ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ê°œì„  ì•„ì´ë””ì–´ê°€ ìˆë‹¤ë©´ ì´ìŠˆë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!
